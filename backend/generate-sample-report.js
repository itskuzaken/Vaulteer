const { initPool } = require('./db/pool');
const eventReportService = require('./services/eventReportService');

async function generateReport() {
  try {
    await initPool();
    
    const eventUid = '407e4942-d8b4-11f0-8c27-0a2d64bcf7c3';
    
    console.log(`Generating analytics report for event: ${eventUid}\n`);
    
    // Check if event exists first
    const pool = require('./db/pool').getPool();
    const [events] = await pool.query(
      'SELECT event_id, uid, title, status, start_datetime, end_datetime FROM events WHERE uid = ?',
      [eventUid]
    );
    
    if (events.length === 0) {
      console.error('❌ Event not found');
      process.exit(1);
    }
    
    const event = events[0];
    console.log('Event Details:');
    console.log(`  - Title: ${event.title}`);
    console.log(`  - Status: ${event.status}`);
    console.log(`  - Start: ${event.start_datetime}`);
    console.log(`  - End: ${event.end_datetime}\n`);
    
    // Generate report
    console.log('Generating report...\n');
    const report = await eventReportService.generateEventReport(eventUid, null, {
      isAutoGenerated: false
    });
    
    console.log('✅ Report Generated Successfully!\n');
    console.log('Report Summary:');
    console.log(`  - Report ID: ${report.report_id}`);
    console.log(`  - Generated At: ${report.generated_at}`);
    console.log('\nAttendance:');
    console.log(`  - Registered: ${report.attendance.total_registered}`);
    console.log(`  - Attended: ${report.attendance.total_attended}`);
    console.log(`  - Absent: ${report.attendance.total_absent}`);
    console.log(`  - Attendance Rate: ${report.attendance.attendance_rate}%`);
    
    if (report.timing) {
      console.log('\nTiming:');
      console.log(`  - On-time Check-ins: ${report.timing.on_time_checkins}`);
      console.log(`  - Late Check-ins: ${report.timing.late_checkins}`);
    }
    
    if (report.demographics) {
      console.log('\nDemographics:');
      if (report.demographics.age) {
        console.log('  Age Distribution:', JSON.stringify(report.demographics.age));
      }
      if (report.demographics.gender) {
        console.log('  Gender Distribution:', JSON.stringify(report.demographics.gender));
      }
    }
    
    if (report.engagement) {
      console.log('\nEngagement:');
      console.log(`  - Total Points Awarded: ${report.engagement.total_points_awarded}`);
      console.log(`  - Badges Earned: ${report.engagement.badges_earned_count}`);
    }
    
    console.log('\n✅ Report saved to database');
    
    process.exit(0);
  } catch (error) {
    console.error('❌ Error:', error.message);
    console.error(error);
    process.exit(1);
  }
}

generateReport();
